function initBrowser(){"use strict";Browser.i18n=chrome.i18n,Browser.extension=chrome.extension,Browser.runtime=chrome.runtime,Browser.agent=null,Browser.keyCombos={},Browser.currentKeys={},Browser.currentPorts={},SAFARI||(chrome.runtime?chrome.runtime.onConnect.addListener(function(e){for(var r=0;r<Browser.messageListeners.length;r++)e.onMessage.addListener(Browser.messageListeners[r]);e.onDisconnect.addListener(function(){Browser.currentPorts[e.portId_]&&delete Browser.currentPorts[e.portId_]}),Browser.currentPorts[e.portId_]=e}):chrome.extension&&chrome.extension.onConnect.addListener(function(e){for(var r=0;r<Browser.messageListeners.length;r++)e.onMessage.addListener(Browser.messageListeners[r]);e.onDisconnect.addListener(function(){Browser.currentPorts[e.portId_]&&delete Browser.currentPorts[e.portId_]}),Browser.currentPorts[e.portId_]=e})),Browser.sendToTab=function(e,r,n){if(SAFARI)try{e.page.dispatchMessage(r.name,r)}catch(s){}else"undefined"!=typeof n&&Browser.currentPorts[n]?Browser.currentPorts[n].postMessage(r):chrome.tabs.sendMessage?chrome.tabs.sendMessage(e.id,r):chrome.tabs.sendRequest(e.id,r)},Browser.sendToExtension=function(e,r){SAFARI?safari.self.tab.dispatchMessage(e.name,e):"undefined"!=typeof r&&Browser.currentPorts[r]?Browser.currentPorts[r].postMessage(e):chrome.runtime?chrome.runtime.sendMessage(e):chrome.extension&&chrome.extension.sendMessage?chrome.extension.sendMessage(e):chrome.extension.sendRequest(e)},Browser.openPort=function(e){if(!SAFARI){e||(e={});var r;return/background\.html$/.test(document.location.href)?r=chrome.tabs.connect(e.tabId):chrome.runtime?r=chrome.runtime.connect():chrome.extension&&(r=chrome.extension.connect()),e.messageHandlers&&r.onMessage.addListener(function(n){e.messageHandlers[n.name]&&e.messageHandlers[n.name](n,r)}),Browser.currentPorts[r.portId_]=r,r.portId_}},Browser.closePort=function(e){!SAFARI&&Browser.currentPorts[e]&&(Browser.currentPorts[e].disconnect(),delete Browser.currentPorts[e])},Browser.getCurrentTab=function(e){SAFARI?e(safari.application.activeBrowserWindow.activeTab):chrome.tabs.query({active:!0,currentWindow:!0},function(r){r&&r.length>0?e(r[0]):(log.warn("chrome tabs query did not return a result while getting current tab"),e())})},Browser.removeMessageHandlers=function(){if(SAFARI){var e=null;e=safari.application?safari.application:safari.self;for(var r=0;r<Browser.messageListeners.length;r++)e.removeEventListener("message",Browser.messageListeners[r],!1),console.log("Removing message listener: "),console.log(Browser.messageListeners[r])}Browser.messageListeners=[]},Browser.addMessageHandlers=function(e,r){var n;if(SAFARI){if("about:blank"==document.location.href)return;if(!r&&window&&window.parent!=window){var s=chrome.extension.getURL("");if(document.location.href.substr(0,s.length)!=s)return}var o=null;if(!safari)return void log.warn("No 'safari' object.");o=safari.application?safari.application:safari.self,n=function(r){r.name&&e[r.name]&&e[r.name](r.message,{tab:r.target},null)},o.addEventListener("message",n,!1)}else n=function(r,n,s){return!n||n.id!==chrome.i18n.getMessage("@@extension_id")&&n.sender&&n.sender.id!==chrome.i18n.getMessage("@@extension_id")?void log.warn("Got request from unexpected sender. Ignoring."):(r.name&&e[r.name]&&e[r.name](r,n,s),s?!0:void 0)},chrome.extension.onMessage?chrome.extension.onMessage.addListener(n):chrome.extension.onRequest.addListener(n);Browser.messageListeners.push(n)},Browser.addKeyboardHandlers=function(e){for(var r in e)Browser.keyCombos[r]=e[r]},Browser.handleKeys=function(){var e=[];for(var r in Browser.currentKeys)e.push(parseInt(r));e.sort(function(e,r){return e-r});var n=e.join(" + ");Browser.keyCombos[n]&&Browser.keyCombos[n](n),Browser.currentKeys={}},Browser.setIcon=function(e){if(SAFARI)for(var r in safari.extension.toolbarItems){var n=safari.extension.toolbarItems[r];"clipper"==n.identifier&&(n.image=safari.extension.baseURI+e+"-16x16.png")}else chrome.browserAction.setIcon({path:{19:chrome.extension.getURL(e+"-19x19.png"),38:chrome.extension.getURL(e+"-19x19@2x.png")}})},Browser.setTitle=function(e){if(SAFARI)for(var r in safari.extension.toolbarItems){var n=safari.extension.toolbarItems[r];"clipper"==n.identifier&&(n.toolTip=e)}else chrome.browserAction.setTitle({title:e})},Browser.setBrowserActionClickHandler=function(e){SAFARI?safari.application.addEventListener("command",function(r){if("clipper"==r.command)for(var n=safari.extension.toolbarItems,s=0;s<n.length;s++)if("clipper"==n[s].identifier){e();break}}):chrome.browserAction.onClicked&&(chrome.browserAction.onClicked.hasListener(e)||chrome.browserAction.onClicked.addListener(e))},Browser.insertJS=function(e,r){SAFARI?(safari.extension.addContentScriptFromURL(safari.extension.baseURI+e),r&&r()):r?chrome.tabs.executeScript(null,{file:e},r):chrome.tabs.executeScript(null,{file:e})},Browser.insertCSS=function(e,r){SAFARI?(safari.extension.addContentStyleSheetFromURL(safari.extension.baseURI+e),r&&r()):r?chrome.tabs.insertCSS(null,{file:e},r):chrome.tabs.insertCSS(null,{file:e})},Browser.captureVisibleTab=function(e,r,n){function s(s){n?n(s):Browser.sendToTab(r.tab,{name:"receiveScreenshot",url:s,tool:e.tool,showSubtools:e.showSubtools})}SAFARI?r.tab.visibleContentsAsDataURL(s):chrome.tabs.captureVisibleTab(r.tab.windowId,{format:e.format||"png",quality:e.quality||1},s)},window.addEventListener("keydown",function(e){189==e.keyCode&&e.altKey?Browser.currentKeys[76]=e:188==e.keyCode&&e.altKey?Browser.currentKeys[80]=e:190==e.keyCode&&e.altKey?Browser.currentKeys[88]=e:Browser.currentKeys[e.keyCode]=e}),window.addEventListener("keyup",function(){Browser.handleKeys()}),Object.preventExtensions(Browser)}if("undefined"==typeof Browser){var Browser={};Browser.runIfInTopFrame=function(e){"use strict";if(SAFARI){e()}else navigator.userAgent.match(/chrome/i)&&e()},Browser.messageListeners=[],Browser.runIfInTopFrame(initBrowser)}